<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Методические рекомендации — Мониторинг, логи и health-check</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- Навигация между файлами -->
  <nav class="nav-files">
    <div class="nav-files__inner">
      <a href="index.htm">1.1. Информационные системы</a>
      <a href="csharpAspnet.htm">1.2. C# и ASP.NET Core</a>
      <a href="dbEfcore.htm">1.3. Базы данных и EF Core</a>
      <a href="restApi.htm">1.4. REST API</a>
      <a href="docker.htm">1.5. Docker</a>
      <a href="docFile.html">1.6. Dockerfile</a>
      <a href="dockerCompose.htm">1.7. Docker Compose</a>
      <a href="monitoring.html">1.8. Мониторинг и логи</a>
      <a href="practices.html">1.9. Практики сопровождения</a>
      <a href="documentation.html" aria-current="page">1.10. Документирование</a>
    </div>
  </nav>

  <main class="page">
    <h1>1.8. Мониторинг, логи и health-check</h1>

    <!-- Навигация по темам -->
    <nav class="nav-topics">
      <div class="nav-topics__title">Оглавление раздела 1.8</div>
      <ul>
        <li><a href="#1-8-0">1.8. Мониторинг, логи и health-check</a></li>
        <li><a href="#1-8-1">1.8.1. Просмотр логов контейнера</a></li>
        <li><a href="#1-8-2">1.8.2. Health-check</a></li>
        <li><a href="#1-8-3">1.8.3. Диагностика ошибок API</a></li>
      </ul>
    </nav>

    <!-- 1.8.0 -->
    <section id="1-8-0">
      <h2>1.8. Мониторинг, логи и health-check</h2>
      <p>
        Мониторинг, анализ логов и проверка состояния приложения — ключевые элементы
        сопровождения информационных систем. Они позволяют обнаруживать ошибки, отслеживать
        состояние API и предотвращать падения контейнеров.
      </p>
    </section>

    <hr />

    <!-- 1.8.1 -->
    <section id="1-8-1">
      <h2>1.8.1. Просмотр логов контейнера</h2>

      <p>Логи отображают:</p>
      <ul>
        <li>ошибки запуска приложения,</li>
        <li>вывод консоли,</li>
        <li>сообщения API,</li>
        <li>исключения .NET,</li>
        <li>системные уведомления контейнера.</li>
      </ul>

      <h3>Команда для просмотра логов</h3>

      <div class="script-block">
docker logs &lt;container_name&gt;
      </div>

      <p>Пример:</p>

      <div class="script-block">
docker logs myapi
      </div>

      <h3>Получение логов в реальном времени</h3>

      <div class="script-block">
docker logs -f myapi
      </div>

      <p><code>-f</code> означает «follow» — потоковый вывод.</p>

      <h3>Зачем нужны логи контейнера</h3>

      <ul>
        <li>быстрое обнаружение ошибок во время запуска,</li>
        <li>диагностика падений или зависаний API,</li>
        <li>просмотр ошибок базы данных,</li>
        <li>анализ внутренних исключений C#/.NET,</li>
        <li>определение, что контейнер вообще запустился.</li>
      </ul>

      <div class="note note--info">
        <div class="note__title">Практический факт</div>
        <p>Логи — первое место, куда смотрит администратор при инциденте.</p>
      </div>
    </section>

    <hr />

    <!-- 1.8.2 -->
    <section id="1-8-2">
      <h2>1.8.2. Health-check: что это и зачем нужно</h2>

      <p>
        Health-check — это механизм автоматической проверки состояния приложения. Он
        показывает не только факт запуска контейнера, но и способность API корректно
        отвечать на запросы.
      </p>

      <p>Проверяется:</p>
      <ul>
        <li>доступность API,</li>
        <li>корректность ответа,</li>
        <li>время отклика.</li>
      </ul>

      <h3>1.8.2.1. Endpoint <code>/health</code></h3>

      <p>Стандартный endpoint:</p>

      <pre><code class="language-http">GET /health</code></pre>

      <p>Пример ответа:</p>

      <pre><code class="language-json">{
  "status": "Healthy"
}</code></pre>

      <p>В ASP.NET Core можно подключить встроенный middleware:</p>

      <div class="script-block">
app.MapHealthChecks("/health");
      </div>

      <h3>1.8.2.2. Health-check в Docker</h3>

      <p>
        Docker может автоматически проверять состояние контейнера с помощью инструкции
        HEALTHCHECK.
      </p>

      <pre><code class="language-dockerfile">HEALTHCHECK --interval=30s --timeout=3s \
  CMD curl -f http://localhost:8080/health || exit 1</code></pre>

      <p>Статусы:</p>
      <ul>
        <li><strong>healthy</strong> — контейнер работает корректно;</li>
        <li><strong>unhealthy</strong> — приложение не отвечает, контейнер повреждён.</li>
      </ul>

      <p>Посмотреть состояние:</p>

      <div class="script-block">
docker ps
      </div>

      <h3>1.8.2.3. Для чего нужен health-check</h3>

      <ul>
        <li>автоматически обнаруживать зависшие приложения,</li>
        <li>перезапускать контейнеры оркестраторами (Docker Swarm, Kubernetes),</li>
        <li>уведомлять администраторов о сбоях,</li>
        <li>не допускать трафик в сломанный контейнер.</li>
      </ul>
    </section>

    <hr />

    <!-- 1.8.3 -->
    <section id="1-8-3">
      <h2>1.8.3. Диагностика ошибок API</h2>

      <p>
        При работе с Web API важно уметь распознавать типичные ошибки, которые возвращаются
        сервисом.
      </p>

      <h3>1.8.3.1. Ошибка 500 — Internal Server Error</h3>

      <p>Причины:</p>
      <ul>
        <li>необработанное исключение в .NET;</li>
        <li>ошибка в бизнес-логике;</li>
        <li>ошибка подключения к базе данных;</li>
        <li>неправильная сериализация JSON;</li>
        <li>неверная конфигурация среды.</li>
      </ul>

      <p>Диагностика:</p>
      <ol>
        <li>Посмотреть логи контейнера:
          <div class="script-block">docker logs myapi</div>
        </li>
        <li>Проверить стек исключений.</li>
        <li>Проверить подключение к БД.</li>
        <li>Проверить переменные среды.</li>
      </ol>

      <h3>1.8.3.2. Ошибка 400 — Bad Request</h3>

      <p>Причины:</p>
      <ul>
        <li>некорректный JSON;</li>
        <li>пропущенные обязательные поля;</li>
        <li>некорректный DTO;</li>
        <li>ошибка валидации атрибутов;</li>
        <li>ошибка параметров запроса.</li>
      </ul>

      <p>Диагностика:</p>
      <ul>
        <li>проверить тело запроса;</li>
        <li>проверить DTO и атрибуты валидации;</li>
        <li>сверить ожидаемую схему данных.</li>
      </ul>

      <h3>1.8.3.3. Падения контейнера</h3>

      <p>Статусы:</p>
      <ul>
        <li><strong>Exited (1)</strong> — ошибка выполнения;</li>
        <li><strong>Restarting</strong> — пытается перезапуститься;</li>
        <li><strong>Dead</strong> — контейнер полностью упал.</li>
      </ul>

      <p>Причины:</p>
      <ul>
        <li>ошибка приложения в точке входа;</li>
        <li>неправильный ENTRYPOINT или CMD;</li>
        <li>неверный порт;</li>
        <li>ошибка в миграциях EF Core;</li>
        <li>отсутствующие зависимости.</li>
      </ul>

      <h3>Как анализировать</h3>

      <ol>
        <li>
          Проверить статус контейнера:
          <div class="script-block">docker ps -a</div>
        </li>
        <li>
          Посмотреть причину:
          <div class="script-block">docker logs &lt;container&gt;</div>
        </li>
        <li>Проверить ENTRYPOINT и EXPOSE.</li>
        <li>Проверить работу базы данных и строку подключения.</li>
      </ol>

      <div class="note note--info">
        <div class="note__title">Совет</div>
        <p>80% ошибок выявляется через просмотр логов и проверку конфигурации.</p>
      </div>
    </section>

  </main>
</body>
</html>
